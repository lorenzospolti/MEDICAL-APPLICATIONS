```{r}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(mice) # For missing data imputation
library(naniar) # For missing data visualization
library(table1)
library(zoo)
```


```{r}
# 1. LOAD DATA
# Note: The files use ';' as a separator
 baseline <-read.csv("MigraineBaselineVars.csv", sep = ";")
 longitudinal <-read.csv("MigraineLongitudianlVars.csv", sep = ";")
```



```{r}
# B. Check structure (Variable types)
# Look for variables that should be Factors but are loaded as int/chr
str(baseline)
```
```{r}
# C. Summary Statistics
# This helps identify outliers (e.g., impossible ages) or scale issues
summary(baseline)
```
```{r}
# A. Check dimensions
cat("Original Baseline Dimensions:", dim(baseline), "\n")

# B. Summary Statistics (Before Cleaning)
summary(baseline$AGE)

#CRITICAL UPDATE: OUTLIER FILTERING ---
# Rationale: We identified unrealistic ages (3, 123). 
# Study inclusion criteria typically require 18-65 years.
# We filter for 18 <= AGE <= 90 to remove data entry errors.

baseline <- baseline %>%
  filter(AGE >= 18 & AGE <= 90)

cat("Dimensions After Outlier Removal:", dim(baseline), "\n")
```

```{r}
# 3b. MISSING DATA PATTERN VISUALIZATION (Task 1)
# ------------------------------------------------------------------------------
# Visualize missingness
gg_miss_var(baseline, show_pct = TRUE) +
  labs(title = "Percentage of Missing Data by Variable (Baseline)",
       subtitle = "High missingness in biometric variables (Height/Weight/BMI)")

# Formal pattern check
md.pattern(baseline, rotate.names = TRUE)

# Note: 
# Only ~23.5% of subjects have complete data. 
# Dropping NAs (Listwise Deletion) would lose 76.5% of the cohort.
# This confirms MICE is strictly necessary.
```


Step 2: Preprocessing & Type Conversion.

In this step, we fix the variable types. R reads CSVs as raw numbers (integers), but the schema defines specific categorical meanings for variables like Sex, Diagnosis, and Antibody. We must convert these to Dummy Variables so statistical models (LMM, Cox) treat them as categories, not numbers.
```{r}
# 4. PREPROCESSING: TYPE CONVERSION (Task 0)
# Convert integers to Factors(dummy Variables) based on Schema definitions 

# Clean Baseline Variables
baseline <- baseline %>%
  mutate(
    # Identifier should be a factor, not a number
    SUBJECT_ID = as.factor(SUBJECT_ID),
    
    # SEX: 1=Female, 2=Male
    SEX = factor(SEX, levels = c(1, 2), labels = c("Female", "Male")),
    
    # DIAGNOSIS: 1=Chronic Migraine, 2=MOH, 3=High Freq Episodic
    DIAGNOSIS = factor(DIAGNOSIS, levels = c(1, 2, 3), 
                       labels = c("Chronic Migraine", "MOH", "Episodic")),
    
    # ANTIBODY: 1=Erenumab, 2=Galcanezumab, 3=Fremanezumab
    ANTIBODY = factor(ANTIBODY, levels = c(1, 2, 3), 
                      labels = c("Erenumab", "Galcanezumab", "Fremanezumab")),
    
    # Suspension: 0=Completed, 1=Discontinued
    Suspension = factor(Suspension, levels = c(0, 1), 
                        labels = c("Completed", "Discontinued")),
    
    # Other binary/categorical indicators
    TREATMENT_DISC = as.factor(TREATMENT_DISC)
  )

# Clean Longitudinal Variables
longitudinal <- longitudinal %>%
  mutate(
    SUBJECT_ID = as.factor(SUBJECT_ID),
    
    # CYCLE is categorical (1, 2, 3), not a continuous number for grouping
    CYCLE = as.factor(CYCLE)
  )
```

```{r}
# 5. DATA MERGING
# Create a 'Master Dataset' for Modeling
# We join Baseline info (static) onto every Longitudinal row (time-varying)

full_data <- left_join(longitudinal, baseline, by = "SUBJECT_ID")

# Check if the merge worked (Rows should match 'longitudinal', Cols should increase)
cat("Full Data Dimensions:", dim(full_data), "\n")
head(full_data)
```
Why this is necessary:

Without this step: A regression model would interpret ANTIBODY = 3 as having "more antibody" than ANTIBODY = 1. Converting to a Dummy variable tells R that these are just three different drug names.

Merging: The full_data object is what we will. feed to lme4 (Mixed Models) later, as it links the patient's daily migraine counts (MMDs) with their baseline history (AGE, BMI).

Step 3: Descriptive Analysis to generate the summary table ("Table 1") and the MMD trajectory plot
This code generates two essential outputs for the report:

"Table 1": A standard clinical table summarizing the demographics (Age, Sex, Diagnosis) of your patient population.

Trajectory Plot: A visualization of how migraine days (MMDs) decrease over time, which answers the schema's question: "Do baseline MMDs progressively decrease over time?".

```{r}
# 6. DESCRIPTIVE ANALYSIS: TABLE 1 (Task 0)
# ------------------------------------------------------------------------------
# Summarize baseline characteristics AFTER outlier removal
label(baseline$AGE)       <- "Age (Years)"
label(baseline$SEX)       <- "Sex"
label(baseline$DIAGNOSIS) <- "Migraine Diagnosis"
label(baseline$BMI)       <- "Body Mass Index"
label(baseline$Suspension)<- "Treatment Status"

# Stratified by ANTIBODY to check randomization balance
table1(~ AGE + SEX + DIAGNOSIS + BMI + Suspension | ANTIBODY, data = baseline)
```
Interpretation of Output:

Table 1: Check if there are major differences between the drug groups (Antibody columns). If one group is much older or has more Chronic Migraine cases, that is a potential bias to mention in our report.

```{r}
# 7. LONGITUDINAL TRAJECTORY PLOT (Task 0 & Q1)
# ------------------------------------------------------------------------------
mmd_summary <- longitudinal %>%
  group_by(CYCLE, MONTH) %>%
  summarise(
    Mean_MMD = mean(MMDs, na.rm = TRUE),
    SE_MMD = sd(MMDs, na.rm = TRUE) / sqrt(n()), 
    .groups = "drop"
  )

ggplot(mmd_summary, aes(x = MONTH, y = Mean_MMD, group = CYCLE, color = CYCLE)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = Mean_MMD - SE_MMD, ymax = Mean_MMD + SE_MMD), width = 0.2) +
  labs(
    title = "Trajectory of MMDs: Evidence of 'Sawtooth' Pattern",
    subtitle = "Rapid onset (M3) followed by 'wearing off' rebound at cycle end [cite: 15]",
    x = "Month within Cycle",
    y = "Mean MMDs (+/- SE)"
  ) +
  scale_x_continuous(breaks = c(1, 3, 6, 9, 12)) +
  theme_minimal()
```
Interpretation of Output:

Trajectory Plot: You should see the red/green/blue lines (Cycles 1, 2, 3) generally sloping downwards. This confirms the treatment is working.

```{r}
# 8. DROPOUT ANALYSIS (Task 0)
# ------------------------------------------------------------------------------
dropout_table <- table(baseline$Suspension)
print(dropout_table)
prop.table(dropout_table) * 100
```

Interpretation of Output:

Dropouts: The prop.table output tells you the exact percentage of patients who did not complete the study. This is a crucial number to report in the "Results" section
#-----

Imputation Comparison & Response Calculation.

This code block addresses: comparing imputation methods (Task 1) and calculating the ≥50% responder rates (Q1).

```{r}
# 9. IMPUTATION COMPARISON (Task 1)
# ------------------------------------------------------------------------------
# Visualizing LOCF vs Linear Interpolation for a single patient
demo_id <- longitudinal$SUBJECT_ID[which(is.na(longitudinal$MMDs))[1]]
demo_data <- longitudinal %>% 
  filter(SUBJECT_ID == demo_id) %>%
  arrange(CYCLE, MONTH) %>%
  mutate(
    MMDs_LOCF = na.locf(MMDs, na.rm = FALSE),
    MMDs_Linear = na.approx(MMDs, na.rm = FALSE)
  )

ggplot(demo_data, aes(x = as.numeric(row.names(demo_data)))) +
  geom_point(aes(y = MMDs), color = "black", size = 4) +
  geom_step(aes(y = MMDs_LOCF), color = "blue", linetype = "dashed", linewidth=1) +
  geom_line(aes(y = MMDs_Linear), color = "red", linetype = "dotted", linewidth=1) +
  labs(title = paste("Imputation: Patient", demo_id),
       subtitle = "Linear (Red) better captures natural fluctuation than LOCF (Blue) ",
       y = "MMDs", x = "Timepoint Sequence") +
  theme_minimal()
```
2. Baseline Imputation with MICE (Required for Task 1)

The schema specifically asks to "compare... multivariate imputation methods (e.g., MICE)". You don't need to use the imputed data for the descriptive plots, but you must generate it for the later modeling phases.

```{r}
# 9b. BASELINE IMPUTATION (MICE) (Task 1)
# ------------------------------------------------------------------------------
# Select variables for imputation
imp_data <- baseline %>%
  dplyr::select(SUBJECT_ID, AGE, SEX, BMI, WEIGTH, FAMILIARITY, DIAGNOSIS, ANTIBODY) 

ini <- mice(imp_data, maxit = 0) 
meth <- ini$method
pred <- ini$predictorMatrix

# Configure MICE
meth["BMI"] <- "pmm"
meth["WEIGTH"] <- "pmm"
meth["FAMILIARITY"] <- "logreg" 
pred[, "SUBJECT_ID"] <- 0 
pred["SUBJECT_ID", ] <- 0

# Run Imputation
imputed_sets <- mice(imp_data, method = meth, predictorMatrix = pred, m = 5, maxit = 10, seed = 123, print = FALSE)

# --- CRITICAL UPDATE: SAVE COMPLETED DATA ---
# This dataset is required for Task 2 (Mixed Models)
baseline_imputed <- complete(imputed_sets, 1) # Extract the first imputed dataset
cat("Missing values in BMI after MICE:", sum(is.na(baseline_imputed$BMI)), "\n")
```
Imputation Plot: This visualizes exactly what Task 1 asks for. You can interpret it in your report: "Linear interpolation (Red) preserves the downward trend of treatment, whereas LOCF (Blue) assumes stability, which might underestimate improvement."
```{r}
# 10. RESPONDER RATES (Q1)
# ------------------------------------------------------------------------------
analysis_data <- full_data %>%
  mutate(
    Pct_Reduction = (GGCEF_T0 - MMDs) / GGCEF_T0 * 100,
    Responder_50 = ifelse(Pct_Reduction >= 50, "Yes", "No"),
    Responder_30 = ifelse(Pct_Reduction >= 30, "Yes", "No")
  )

reduction_summary <- analysis_data %>%
  group_by(CYCLE) %>%
  summarise(
    N_Patients = n(),
    Mean_Red_Pct  = round(mean(Pct_Reduction, na.rm = TRUE), 1),
    Rate_30_Pct = round(mean(Responder_30 == "Yes", na.rm = TRUE) * 100, 1),
    Rate_50_Pct = round(mean(Responder_50 == "Yes", na.rm = TRUE) * 100, 1)
  )

print(reduction_summary)
```


Responder Summary: The responder_summary table gives you the exact numbers for Q1. You can now write a sentence like: "The proportion of patients achieving ≥50% reduction increased from X% in Cycle 1 to Y% in Cycle 3.


